<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Server 716 Analytics</title>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
    background: #0a0e17;
    color: #c8d6e5;
    min-height: 100vh;
    line-height: 1.5;
  }

  .container { max-width: 1400px; margin: 0 auto; padding: 20px; }

  /* Header */
  header {
    text-align: center;
    padding: 30px 0 20px;
    border-bottom: 1px solid #1a2332;
    margin-bottom: 24px;
  }
  header h1 {
    font-size: 1.8rem;
    color: #e2e8f0;
    letter-spacing: 1px;
  }
  header h1 span { color: #4dabf7; }
  .updated {
    font-size: 0.85rem;
    color: #636e7b;
    margin-top: 6px;
  }

  /* Login */
  #login-gate {
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 60vh;
  }
  .login-box {
    background: #111827;
    border: 1px solid #1e2d3d;
    border-radius: 12px;
    padding: 40px;
    text-align: center;
    max-width: 360px;
    width: 100%;
  }
  .login-box h2 {
    color: #e2e8f0;
    font-size: 1.3rem;
    margin-bottom: 20px;
  }
  .login-box input {
    width: 100%;
    padding: 10px 14px;
    background: #0a0e17;
    border: 1px solid #1e2d3d;
    border-radius: 6px;
    color: #c8d6e5;
    font-size: 1rem;
    font-family: inherit;
    margin-bottom: 14px;
  }
  .login-box input:focus {
    outline: none;
    border-color: #4dabf7;
  }
  .login-box button {
    width: 100%;
    padding: 10px;
    background: #4dabf7;
    color: #0a0e17;
    border: none;
    border-radius: 6px;
    font-size: 1rem;
    font-weight: 600;
    font-family: inherit;
    cursor: pointer;
    transition: background 0.15s;
  }
  .login-box button:hover { background: #74c0fc; }
  .login-error {
    color: #f87171;
    font-size: 0.85rem;
    margin-top: 10px;
    min-height: 1.2em;
  }

  /* Tabs */
  .tab-bar {
    display: flex;
    gap: 6px;
    margin-bottom: 24px;
    flex-wrap: wrap;
    justify-content: center;
  }
  .tab-btn {
    background: #111827;
    border: 1px solid #1e2d3d;
    color: #8899aa;
    padding: 8px 18px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.85rem;
    font-family: inherit;
    transition: all 0.15s;
  }
  .tab-btn:hover { border-color: #4dabf7; color: #c8d6e5; }
  .tab-btn.active {
    background: #4dabf7;
    color: #0a0e17;
    border-color: #4dabf7;
    font-weight: 600;
  }

  /* Tables */
  .table-wrap {
    overflow-x: auto;
    border: 1px solid #1e2d3d;
    border-radius: 10px;
  }
  table {
    width: 100%;
    border-collapse: collapse;
  }
  th, td {
    padding: 10px 14px;
    text-align: left;
    white-space: nowrap;
  }
  th {
    background: #111827;
    color: #8899aa;
    font-size: 0.78rem;
    text-transform: uppercase;
    letter-spacing: 0.8px;
    cursor: pointer;
    user-select: none;
    position: sticky;
    top: 0;
  }
  th:hover { color: #4dabf7; }
  th .arrow { margin-left: 4px; font-size: 0.7rem; }
  tr { border-bottom: 1px solid #1a2332; }
  tr:last-child { border-bottom: none; }
  tr:hover td { background: #111827; }
  td { font-size: 0.9rem; }
  tr.ncc-row td { background: #111d2e; }

  /* Clickable rows */
  tr.clickable { cursor: pointer; }
  tr.clickable:hover td { background: #162030; }

  /* Summary cards */
  .cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 14px;
    margin-bottom: 20px;
  }
  .card {
    background: #111827;
    border: 1px solid #1e2d3d;
    border-radius: 10px;
    padding: 16px;
    text-align: center;
  }
  .card .label {
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: #636e7b;
    margin-bottom: 4px;
  }
  .card .value {
    font-size: 1.5rem;
    font-weight: 700;
    color: #4dabf7;
  }

  /* Search input */
  .search-wrap {
    margin-bottom: 20px;
    text-align: center;
  }
  .search-input {
    width: 100%;
    max-width: 500px;
    padding: 10px 16px;
    background: #111827;
    border: 1px solid #1e2d3d;
    border-radius: 8px;
    color: #c8d6e5;
    font-size: 1rem;
    font-family: inherit;
  }
  .search-input:focus {
    outline: none;
    border-color: #4dabf7;
  }
  .search-hint {
    font-size: 0.78rem;
    color: #4a5568;
    margin-top: 6px;
  }

  /* Alliance selector */
  .selector-wrap {
    margin-bottom: 20px;
  }
  .selector-wrap select {
    padding: 8px 14px;
    background: #111827;
    border: 1px solid #1e2d3d;
    border-radius: 6px;
    color: #c8d6e5;
    font-size: 0.95rem;
    font-family: inherit;
    min-width: 200px;
  }
  .selector-wrap select:focus {
    outline: none;
    border-color: #4dabf7;
  }
  .selector-wrap label {
    color: #8899aa;
    font-size: 0.85rem;
    margin-right: 8px;
  }

  /* Comparison layout */
  .compare-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 20px;
  }
  .compare-row {
    display: flex;
    align-items: center;
    padding: 10px 0;
    border-bottom: 1px solid #1a2332;
  }
  .compare-row:last-child { border-bottom: none; }
  .compare-label {
    width: 140px;
    font-size: 0.78rem;
    text-transform: uppercase;
    color: #8899aa;
    letter-spacing: 0.8px;
    flex-shrink: 0;
  }
  .compare-bars {
    flex: 1;
    display: flex;
    gap: 8px;
    align-items: center;
  }
  .compare-bar {
    height: 22px;
    border-radius: 4px;
    transition: width 0.3s;
    min-width: 2px;
  }
  .compare-val {
    font-size: 0.85rem;
    min-width: 70px;
    font-variant-numeric: tabular-nums;
  }
  .compare-val-left { text-align: right; }

  /* Movement section headers */
  .section-header {
    font-size: 1.15rem;
    color: #e2e8f0;
    font-weight: 600;
    padding-bottom: 10px;
    border-bottom: 1px solid #1e2d3d;
    margin-bottom: 16px;
    margin-top: 24px;
  }
  .section-header:first-child { margin-top: 0; }

  /* Delta colors */
  .delta-pos { color: #34d399; }
  .delta-neg { color: #f87171; }
  .delta-zero { color: #3a4250; }

  /* Player name links */
  .player-link { color: #4dabf7; text-decoration: none; }
  .player-link:hover { text-decoration: underline; }

  /* Loading / Error */
  .loading {
    text-align: center;
    padding: 60px 0;
    color: #636e7b;
    font-size: 1.1rem;
  }
  .error { color: #f87171; }

  .empty {
    color: #4a5568;
    font-style: italic;
    padding: 20px 0;
    text-align: center;
  }

  /* Footer */
  footer {
    text-align: center;
    padding: 24px 0;
    margin-top: 28px;
    border-top: 1px solid #1a2332;
    font-size: 0.8rem;
    color: #4a5568;
  }
  footer a { color: #4dabf7; text-decoration: none; }
  footer a:hover { text-decoration: underline; }

  @media (max-width: 600px) {
    .container { padding: 12px; }
    header h1 { font-size: 1.3rem; }
    .compare-grid { grid-template-columns: 1fr; }
  }
</style>
</head>
<body>
<div class="container">
  <header>
    <h1><span>Server 716</span> Analytics</h1>
    <div class="updated" id="updated"></div>
  </header>

  <div id="login-gate">
    <div class="login-box">
      <h2>Server Analytics</h2>
      <input type="password" id="pw-input" placeholder="Enter password" autocomplete="off">
      <button id="pw-btn">Enter</button>
      <div class="login-error" id="pw-error"></div>
    </div>
  </div>

  <div id="content" style="display:none">
    <div class="loading">Loading server data...</div>
  </div>

  <footer style="display:none" id="footer-el">
    Data sourced from <a href="https://stfc.pro" target="_blank" rel="noopener">stfc.pro</a>
    &middot; <a href="index">Main Dashboard</a>
  </footer>
</div>

<script>
(function() {
  const $ = id => document.getElementById(id);
  const NCC_ID = 3974286889;

  // --- Auth gate (same as admin.html) ---
  const PASSWORD = 'salsa';

  function checkAuth() {
    return sessionStorage.getItem('ncc_admin_auth') === 'ok';
  }

  function showDashboard() {
    $('login-gate').style.display = 'none';
    $('content').style.display = '';
    $('footer-el').style.display = '';
    loadData();
  }

  if (checkAuth()) {
    showDashboard();
  } else {
    $('pw-btn').addEventListener('click', tryLogin);
    $('pw-input').addEventListener('keydown', e => { if (e.key === 'Enter') tryLogin(); });
  }

  function tryLogin() {
    const val = $('pw-input').value;
    if (val === PASSWORD) {
      sessionStorage.setItem('ncc_admin_auth', 'ok');
      showDashboard();
    } else {
      $('pw-error').textContent = 'Incorrect password';
      $('pw-input').value = '';
      $('pw-input').focus();
    }
  }

  // --- Utilities ---
  function esc(s) {
    const el = document.createElement('span');
    el.textContent = s == null ? '' : String(s);
    return el.innerHTML;
  }

  function formatAbbr(n) {
    if (n == null) n = 0;
    if (n === 0) return '0';
    const abs = Math.abs(n);
    const sign = n < 0 ? '-' : '';
    let val, suf;
    if (abs >= 1e15)      { val = abs / 1e15; suf = 'Q'; }
    else if (abs >= 1e12) { val = abs / 1e12; suf = 'T'; }
    else if (abs >= 1e9)  { val = abs / 1e9;  suf = 'B'; }
    else if (abs >= 1e6)  { val = abs / 1e6;  suf = 'M'; }
    else if (abs >= 1e3)  { val = abs / 1e3;  suf = 'K'; }
    else                  { val = abs;         suf = '';  }
    return sign + val.toFixed(2).replace(/\.?0+$/, '') + suf;
  }

  function formatDelta(n) {
    if (n === 0) return '<span class="delta-zero">0</span>';
    const cls = n > 0 ? 'delta-pos' : 'delta-neg';
    const sign = n > 0 ? '+' : '';
    return `<span class="${cls}">${sign}${formatAbbr(n)}</span>`;
  }

  function formatNum(n) {
    if (n == null) return '0';
    return Number(n).toLocaleString();
  }

  function playerLink(p) {
    return `<a class="player-link" href="player?id=${encodeURIComponent(p.id)}">${esc(p.name)}</a>`;
  }

  // --- Data ---
  let allianceData = null; // server_alliances.json
  let playerData = null;   // server_players.json
  let currentTab = 'leaderboard';
  let detailAllianceId = null;

  // Sort state per tab
  let lbSortCol = 'total_power';
  let lbSortAsc = false;
  let detailSortCol = 'power';
  let detailSortAsc = false;

  function loadData() {
    const t = Date.now();
    const ap = fetch('data/server_alliances.json?t=' + t)
      .then(r => { if (!r.ok) throw new Error('HTTP ' + r.status); return r.json(); });
    const pp = fetch('data/server_players.json?t=' + t)
      .then(r => { if (!r.ok) throw new Error('HTTP ' + r.status); return r.json(); });

    Promise.all([ap, pp])
      .then(([a, p]) => {
        allianceData = a;
        playerData = p;
        const d = new Date(a.pulled_at);
        $('updated').textContent = 'Last updated: ' + d.toLocaleDateString('en-US', {
          year: 'numeric', month: 'short', day: 'numeric',
          hour: '2-digit', minute: '2-digit'
        });
        renderPage();
      })
      .catch(err => {
        $('content').innerHTML = `<div class="loading error">Failed to load data: ${esc(err.message)}<br>Run pull_api.py to generate server JSON files.</div>`;
      });
  }

  function renderPage() {
    let html = '';

    // Tab bar
    const tabs = [
      ['leaderboard', 'Alliance Leaderboard'],
      ['detail', 'Alliance Detail'],
      ['search', 'Player Search'],
      ['compare', 'Alliance Comparison'],
      ['movements', 'Player Movements'],
    ];
    html += '<div class="tab-bar">';
    for (const [id, label] of tabs) {
      const cls = currentTab === id ? ' active' : '';
      html += `<button class="tab-btn${cls}" data-tab="${id}">${label}</button>`;
    }
    html += '</div>';

    html += '<div id="tab-content"></div>';
    $('content').innerHTML = html;

    // Attach tab handlers
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        currentTab = btn.dataset.tab;
        renderPage();
      });
    });

    renderTab();
  }

  function renderTab() {
    const el = document.getElementById('tab-content');
    if (!el) return;

    switch (currentTab) {
      case 'leaderboard': el.innerHTML = renderLeaderboard(); attachLeaderboardHandlers(); break;
      case 'detail':      el.innerHTML = renderDetail();      attachDetailHandlers(); break;
      case 'search':      el.innerHTML = renderSearch();      attachSearchHandlers(); break;
      case 'compare':     el.innerHTML = renderCompare();     attachCompareHandlers(); break;
      case 'movements':   el.innerHTML = renderMovements();   break;
    }
  }

  // ===== TAB 1: Alliance Leaderboard =====
  function renderLeaderboard() {
    const alliances = [...allianceData.alliances];

    const cols = [
      { key: 'rank',         label: 'Rank' },
      { key: 'alliance_tag', label: 'Tag' },
      { key: 'member_count', label: 'Members' },
      { key: 'avg_level',    label: 'Avg Level' },
      { key: 'total_power',  label: 'Total Power' },
      { key: 'power_delta_7d', label: '7d Delta' },
      { key: 'total_pvp',    label: 'PVP Kills' },
      { key: 'total_hk',     label: 'Hostile Kills' },
      { key: 'total_mined',  label: 'RSS Mined' },
      { key: 'total_raided', label: 'RSS Raided' },
    ];

    // Sort
    const sortDef = cols.find(c => c.key === lbSortCol);
    if (sortDef) {
      if (lbSortCol === 'alliance_tag') {
        alliances.sort((a, b) => {
          const v = (a.alliance_tag || '').localeCompare(b.alliance_tag || '');
          return lbSortAsc ? v : -v;
        });
      } else {
        alliances.sort((a, b) => {
          const v = (a[lbSortCol] || 0) - (b[lbSortCol] || 0);
          return lbSortAsc ? v : -v;
        });
      }
    }

    // Summary cards
    let html = '<div class="cards">';
    html += `<div class="card"><div class="label">Alliances</div><div class="value">${allianceData.alliance_count}</div></div>`;
    html += `<div class="card"><div class="label">Total Players</div><div class="value">${playerData.player_count}</div></div>`;
    html += `<div class="card"><div class="label">As Of</div><div class="value">${esc(allianceData.as_of_date)}</div></div>`;
    html += `<div class="card"><div class="label">Delta Base</div><div class="value">${esc(allianceData.delta_base_date)}</div></div>`;
    html += '</div>';

    // Table
    html += '<div class="table-wrap"><table><thead><tr>';
    for (const col of cols) {
      const arrow = lbSortCol === col.key ? (lbSortAsc ? '&#9650;' : '&#9660;') : '';
      html += `<th data-col="${col.key}">${col.label}<span class="arrow">${arrow}</span></th>`;
    }
    html += '</tr></thead><tbody>';

    for (const a of alliances) {
      const isNcc = a.alliance_id === NCC_ID;
      const rowCls = (isNcc ? ' ncc-row' : '') + ' clickable';
      html += `<tr class="${rowCls.trim()}" data-aid="${a.alliance_id}">`;
      html += `<td>${a.rank}</td>`;
      html += `<td><strong>${esc(a.alliance_tag)}</strong></td>`;
      html += `<td>${a.member_count}</td>`;
      html += `<td>${a.avg_level}</td>`;
      html += `<td>${formatAbbr(a.total_power)}</td>`;
      html += `<td>${formatDelta(a.power_delta_7d)}</td>`;
      html += `<td>${formatAbbr(a.total_pvp)}</td>`;
      html += `<td>${formatAbbr(a.total_hk)}</td>`;
      html += `<td>${formatAbbr(a.total_mined)}</td>`;
      html += `<td>${formatAbbr(a.total_raided)}</td>`;
      html += '</tr>';
    }
    html += '</tbody></table></div>';
    return html;
  }

  function attachLeaderboardHandlers() {
    document.querySelectorAll('#tab-content th[data-col]').forEach(th => {
      th.addEventListener('click', () => {
        const col = th.dataset.col;
        if (lbSortCol === col) lbSortAsc = !lbSortAsc;
        else { lbSortCol = col; lbSortAsc = col === 'alliance_tag'; }
        document.getElementById('tab-content').innerHTML = renderLeaderboard();
        attachLeaderboardHandlers();
      });
    });

    // Click row â†’ alliance detail
    document.querySelectorAll('#tab-content tr.clickable').forEach(tr => {
      tr.addEventListener('click', () => {
        detailAllianceId = parseInt(tr.dataset.aid);
        currentTab = 'detail';
        renderPage();
      });
    });
  }

  // ===== TAB 2: Alliance Detail =====
  function renderDetail() {
    const alliances = allianceData.alliances;

    let html = '<div class="selector-wrap"><label>Alliance:</label>';
    html += '<select id="alliance-select">';
    html += '<option value="">-- Select Alliance --</option>';
    for (const a of alliances) {
      const sel = a.alliance_id === detailAllianceId ? ' selected' : '';
      html += `<option value="${a.alliance_id}"${sel}>[${esc(a.alliance_tag)}] ${a.member_count} members - ${formatAbbr(a.total_power)}</option>`;
    }
    html += '</select></div>';

    if (!detailAllianceId) {
      html += '<div class="empty">Select an alliance to view details</div>';
      return html;
    }

    const info = alliances.find(a => a.alliance_id === detailAllianceId);
    const members = playerData.players.filter(p => p.alliance_id === detailAllianceId);

    if (!info) {
      html += '<div class="empty">Alliance not found</div>';
      return html;
    }

    // Summary cards
    html += '<div class="cards">';
    html += `<div class="card"><div class="label">Tag</div><div class="value">${esc(info.alliance_tag)}</div></div>`;
    html += `<div class="card"><div class="label">Members</div><div class="value">${info.member_count}</div></div>`;
    html += `<div class="card"><div class="label">Total Power</div><div class="value">${formatAbbr(info.total_power)}</div></div>`;
    html += `<div class="card"><div class="label">Avg Level</div><div class="value">${info.avg_level}</div></div>`;
    html += `<div class="card"><div class="label">Max Level</div><div class="value">${info.max_level}</div></div>`;
    html += `<div class="card"><div class="label">7d Power Delta</div><div class="value">${formatDelta(info.power_delta_7d)}</div></div>`;
    html += '</div>';

    // Sort members
    const cols = [
      { key: 'name',             label: 'Name' },
      { key: 'level',            label: 'Level' },
      { key: 'power',            label: 'Power' },
      { key: 'power_delta_7d',   label: '7d Delta' },
      { key: 'helps',            label: 'Helps' },
      { key: 'rss_contrib',      label: 'RSS Contrib' },
      { key: 'iso_contrib',      label: 'ISO Contrib' },
      { key: 'players_killed',   label: 'PVP Kills' },
      { key: 'hostiles_killed',  label: 'Hostile Kills' },
      { key: 'resources_mined',  label: 'RSS Mined' },
      { key: 'resources_raided', label: 'RSS Raided' },
    ];

    if (detailSortCol === 'name') {
      members.sort((a, b) => {
        const v = a.name.localeCompare(b.name);
        return detailSortAsc ? v : -v;
      });
    } else {
      members.sort((a, b) => {
        const v = (a[detailSortCol] || 0) - (b[detailSortCol] || 0);
        return detailSortAsc ? v : -v;
      });
    }

    html += '<div class="table-wrap"><table><thead><tr>';
    for (const col of cols) {
      const arrow = detailSortCol === col.key ? (detailSortAsc ? '&#9650;' : '&#9660;') : '';
      html += `<th data-col="${col.key}">${col.label}<span class="arrow">${arrow}</span></th>`;
    }
    html += '</tr></thead><tbody>';

    for (const p of members) {
      html += '<tr>';
      html += `<td>${playerLink(p)}</td>`;
      html += `<td>${p.level}</td>`;
      html += `<td>${formatAbbr(p.power)}</td>`;
      html += `<td>${formatDelta(p.power_delta_7d)}</td>`;
      html += `<td>${formatAbbr(p.helps)}</td>`;
      html += `<td>${formatAbbr(p.rss_contrib)}</td>`;
      html += `<td>${formatAbbr(p.iso_contrib)}</td>`;
      html += `<td>${formatAbbr(p.players_killed)}</td>`;
      html += `<td>${formatAbbr(p.hostiles_killed)}</td>`;
      html += `<td>${formatAbbr(p.resources_mined)}</td>`;
      html += `<td>${formatAbbr(p.resources_raided)}</td>`;
      html += '</tr>';
    }
    html += '</tbody></table></div>';
    return html;
  }

  function attachDetailHandlers() {
    const sel = document.getElementById('alliance-select');
    if (sel) {
      sel.addEventListener('change', () => {
        detailAllianceId = sel.value ? parseInt(sel.value) : null;
        document.getElementById('tab-content').innerHTML = renderDetail();
        attachDetailHandlers();
      });
    }

    document.querySelectorAll('#tab-content th[data-col]').forEach(th => {
      th.addEventListener('click', () => {
        const col = th.dataset.col;
        if (detailSortCol === col) detailSortAsc = !detailSortAsc;
        else { detailSortCol = col; detailSortAsc = col === 'name'; }
        document.getElementById('tab-content').innerHTML = renderDetail();
        attachDetailHandlers();
      });
    });
  }

  // ===== TAB 3: Player Search =====
  let searchQuery = '';

  function renderSearch() {
    let html = '<div class="search-wrap">';
    html += `<input type="text" class="search-input" id="search-input" placeholder="Search players by name..." value="${esc(searchQuery)}" autofocus>`;
    html += '<div class="search-hint">Type at least 2 characters to search across all ~' + playerData.player_count + ' players</div>';
    html += '</div>';

    if (searchQuery.length < 2) {
      return html;
    }

    const q = searchQuery.toLowerCase();
    const matches = playerData.players.filter(p => p.name.toLowerCase().includes(q));

    if (matches.length === 0) {
      html += '<div class="empty">No players found</div>';
      return html;
    }

    html += `<div style="text-align:center;font-size:0.85rem;color:#636e7b;margin-bottom:12px;">${matches.length} result${matches.length !== 1 ? 's' : ''}</div>`;

    html += '<div class="table-wrap"><table><thead><tr>';
    html += '<th>Name</th><th>Alliance</th><th>Level</th><th>Power</th><th>7d Delta</th>';
    html += '</tr></thead><tbody>';

    const shown = matches.slice(0, 100);
    for (const p of shown) {
      html += '<tr>';
      html += `<td>${playerLink(p)}</td>`;
      html += `<td>${esc(p.alliance_tag)}</td>`;
      html += `<td>${p.level}</td>`;
      html += `<td>${formatAbbr(p.power)}</td>`;
      html += `<td>${formatDelta(p.power_delta_7d)}</td>`;
      html += '</tr>';
    }
    html += '</tbody></table></div>';

    if (matches.length > 100) {
      html += `<div class="empty">Showing first 100 of ${matches.length} results. Refine your search.</div>`;
    }

    return html;
  }

  function attachSearchHandlers() {
    const input = document.getElementById('search-input');
    if (input) {
      input.addEventListener('input', () => {
        searchQuery = input.value;
        // Re-render just the results, not the whole page
        const el = document.getElementById('tab-content');
        el.innerHTML = renderSearch();
        attachSearchHandlers();
        // Re-focus and restore cursor position
        const newInput = document.getElementById('search-input');
        if (newInput) {
          newInput.focus();
          newInput.setSelectionRange(newInput.value.length, newInput.value.length);
        }
      });
    }
  }

  // ===== TAB 4: Alliance Comparison =====
  let compareA = null;
  let compareB = null;

  function renderCompare() {
    const alliances = allianceData.alliances;

    let html = '<div class="compare-grid">';
    for (const [side, selected, label] of [['a', compareA, 'Alliance A'], ['b', compareB, 'Alliance B']]) {
      html += `<div class="selector-wrap"><label>${label}:</label>`;
      html += `<select id="compare-${side}">`;
      html += '<option value="">-- Select --</option>';
      for (const a of alliances) {
        const sel = a.alliance_id === selected ? ' selected' : '';
        html += `<option value="${a.alliance_id}"${sel}>[${esc(a.alliance_tag)}] ${formatAbbr(a.total_power)}</option>`;
      }
      html += '</select></div>';
    }
    html += '</div>';

    if (!compareA || !compareB) {
      html += '<div class="empty">Select two alliances to compare</div>';
      return html;
    }

    const a = alliances.find(x => x.alliance_id === compareA);
    const b = alliances.find(x => x.alliance_id === compareB);
    if (!a || !b) {
      html += '<div class="empty">Alliance not found</div>';
      return html;
    }

    const metrics = [
      { key: 'member_count', label: 'Members' },
      { key: 'avg_level',    label: 'Avg Level' },
      { key: 'max_level',    label: 'Max Level' },
      { key: 'total_power',  label: 'Total Power' },
      { key: 'power_delta_7d', label: '7d Power Delta' },
      { key: 'total_pvp',    label: 'PVP Kills' },
      { key: 'total_hk',     label: 'Hostile Kills' },
      { key: 'total_mined',  label: 'RSS Mined' },
      { key: 'total_raided', label: 'RSS Raided' },
    ];

    html += `<div style="display:flex;justify-content:space-between;margin-bottom:12px;">`;
    html += `<strong style="color:#4dabf7;font-size:1.1rem;">[${esc(a.alliance_tag)}]</strong>`;
    html += `<strong style="color:#fb923c;font-size:1.1rem;">[${esc(b.alliance_tag)}]</strong>`;
    html += '</div>';

    for (const m of metrics) {
      const va = a[m.key] || 0;
      const vb = b[m.key] || 0;
      const maxVal = Math.max(Math.abs(va), Math.abs(vb), 1);
      const pctA = (Math.abs(va) / maxVal) * 100;
      const pctB = (Math.abs(vb) / maxVal) * 100;

      html += '<div class="compare-row">';
      html += `<div class="compare-label">${m.label}</div>`;
      html += '<div class="compare-bars" style="flex-direction:column;gap:4px;">';

      html += '<div style="display:flex;align-items:center;width:100%;gap:8px;">';
      html += `<span class="compare-val compare-val-left" style="color:#4dabf7">${formatAbbr(va)}</span>`;
      html += `<div style="flex:1;background:#1a2332;border-radius:4px;height:22px;position:relative;">`;
      html += `<div class="compare-bar" style="width:${pctA}%;background:#4dabf7;position:absolute;left:0;top:0;"></div>`;
      html += `</div>`;
      html += '</div>';

      html += '<div style="display:flex;align-items:center;width:100%;gap:8px;">';
      html += `<span class="compare-val compare-val-left" style="color:#fb923c">${formatAbbr(vb)}</span>`;
      html += `<div style="flex:1;background:#1a2332;border-radius:4px;height:22px;position:relative;">`;
      html += `<div class="compare-bar" style="width:${pctB}%;background:#fb923c;position:absolute;left:0;top:0;"></div>`;
      html += `</div>`;
      html += '</div>';

      html += '</div></div>';
    }

    return html;
  }

  function attachCompareHandlers() {
    const selA = document.getElementById('compare-a');
    const selB = document.getElementById('compare-b');
    if (selA) {
      selA.addEventListener('change', () => {
        compareA = selA.value ? parseInt(selA.value) : null;
        document.getElementById('tab-content').innerHTML = renderCompare();
        attachCompareHandlers();
      });
    }
    if (selB) {
      selB.addEventListener('change', () => {
        compareB = selB.value ? parseInt(selB.value) : null;
        document.getElementById('tab-content').innerHTML = renderCompare();
        attachCompareHandlers();
      });
    }
  }

  // ===== TAB 5: Player Movements =====
  function renderMovements() {
    const moved = playerData.players.filter(p => p.moved);

    if (moved.length === 0) {
      return '<div class="empty">No player movements detected in the last 7 days</div>';
    }

    // Split into NCC-related and other
    const nccMoves = moved.filter(p =>
      p.alliance_id === NCC_ID || (p.prev_alliance_tag && p.prev_alliance_tag === 'NCC')
    );
    const otherMoves = moved.filter(p =>
      p.alliance_id !== NCC_ID && (p.prev_alliance_tag !== 'NCC')
    );

    let html = '';

    function movementTable(players, title) {
      if (players.length === 0) return '';
      let s = `<div class="section-header">${title} (${players.length})</div>`;
      s += '<div class="table-wrap"><table><thead><tr>';
      s += '<th>Player</th><th>From</th><th>To</th><th>Level</th><th>Power</th>';
      s += '</tr></thead><tbody>';
      for (const p of players) {
        s += '<tr>';
        s += `<td>${playerLink(p)}</td>`;
        s += `<td>${esc(p.prev_alliance_tag || '(none)')}</td>`;
        s += `<td>${esc(p.alliance_tag || '(none)')}</td>`;
        s += `<td>${p.level}</td>`;
        s += `<td>${formatAbbr(p.power)}</td>`;
        s += '</tr>';
      }
      s += '</tbody></table></div>';
      return s;
    }

    if (nccMoves.length > 0) {
      html += movementTable(nccMoves, 'NCC-Related Movements');
    }
    if (otherMoves.length > 0) {
      html += movementTable(otherMoves, 'Other Alliance Movements');
    }

    return html;
  }

})();
</script>
</body>
</html>
